# Архитектура данных prepy

Приложение для виртуального IELTS: 4 этапа (Listening, Reading, Writing, Speaking), много тестов по темам, статистика и геймификация, вход через Email / Apple / Google, синхронизация между устройствами.

---

## 1. Что храним локально (iPhone / UserDefaults)

Всё, что не требует синхронизации и относится к настройкам устройства:

| Данные | Где | Зачем |
|--------|-----|--------|
| Тема (светлая/тёмная/системная) | UserDefaults | Настройки отображения |
| Уведомления вкл/выкл | UserDefaults | Настройки |
| Целевой band (target band) | UserDefaults | Можно и на сервере — при мультиустройстве лучше синхронизировать (см. ниже) |
| Любые другие настройки приложения | UserDefaults | Локальные предпочтения |
| Кэш тестов/вопросов/аудио | Локальная папка или SQLite | Офлайн-доступ после первой загрузки (тесты работают только с интернетом, но кэш ускоряет повторные открытия) |

**Рекомендация:** целевой band и имя/аватар можно дублировать на сервер (профиль), чтобы при входе с другого устройства сразу подтягивать цель и отображаемое имя. Локально тогда храним только «последнее известное» значение и тему/уведомления.

---

## 2. Что храним на сервере (Supabase)

### 2.1. Пользователи и профиль

- **auth.users** (Supabase Auth): Email, Apple, Google — вход через все три.
- **profiles** (расширение): `user_id`, `display_name`, `avatar_url`, `target_band`, `created_at`, `updated_at`.  
  Нужен для мультиустройства и геймификации (streak, слова и т.д. привязаны к `user_id`).

### 2.2. Тесты и контент

- **tests** — много тестов на разные темы: `id`, `title`, `topic_slug`, `created_at`.
- **listening_audio** — аудио по тестам: `test_id`, часть (1–4), путь в Storage, длительность.
- **reading_passages** — тексты Reading: `test_id`, номер пассажа, заголовок, текст, опционально изображение.
- **writing_prompts** — промпты Writing: `test_id`, номер задания, текст промпта.
- **speaking_prompts** — промпты Speaking: `test_id`, номер части, текст промпта.
- **questions** — пул вопросов к тесту: `test_id`, секция (listening/reading/…), часть/пассаж, тип вопроса (multiple_choice, fill_blank, matching и т.д.), текст, варианты (JSON), порядок.

Аудио файлы лежат в **Supabase Storage** (bucket), в таблицах — только ссылки/пути.

### 2.3. Результаты (без сырых ответов)

Ответы пользователя **не сохраняем**. Они уходят в нейросеть → возвращаются выводы → сохраняем только выводы.

- **attempts** — попытка теста: `user_id`, `test_id`, `started_at`, `completed_at`, `status` (in_progress / completed).
- **attempt_scores** — баллы по секциям: `attempt_id`, секция (listening/reading/writing/speaking), `score` (band 0–9). Все попытки храним для графиков.
- **attempt_insights** — выводы нейросети: `attempt_id`, секция, `insights_json` (слабости, типы вопросов, пробелы). Сюда же можно писать «слова/фразы, в которых ошибся» для будущих флеш-карт.

### 2.4. Геймификация и общая статистика

- **user_stats** — агрегат по пользователю: `user_id`, `daily_streak`, `words_learned_count`, `last_activity_date`, `current_level` (оценка общего band). Обновляется при завершении попытки или при изучении слов.

### 2.5. Словарь и флеш-карточки (будущее)

- **vocabulary** — общая база слов: `id`, `word`, `definition`, `example`, `topic` (опционально).
- **user_flashcards** (или **user_vocabulary**) — карточки пользователя: `user_id`, источник (слово из `vocabulary` или из `attempt_insights`), `mastered`, `next_review`. Слова берутся и из ошибок по тестам, и из общей базы.

### 2.6. Ресурсы (будущее, гибко)

- **resources** — заглушка: `id`, `type` (listening/reading/…), `title`, `url_or_content`, `metadata` (JSON). Позже решите: ссылки, встроенный контент или файлы в Storage.

---

## 3. Поток данных

1. Пользователь проходит тест (Listening → Reading → Writing → Speaking).
2. Ответы (и при необходимости аудио/текст эссе) отправляются в **ваш бэкенд/нейросеть** (не в Supabase как сырые ответы).
3. Нейросеть возвращает: баллы по секциям, выводы (слабости, типы ошибок, слова для доработки).
4. Приложение пишет в Supabase:
   - **attempts** + **attempt_scores** + **attempt_insights**.
   - Обновляет **user_stats** (streak, last_activity, при необходимости current_level).
5. Для графиков и истории — читаем **attempts** + **attempt_scores** по `user_id`.

---

## 4. Кэш

- После первой загрузки теста (метаданные + вопросы + ссылки на аудио) можно кэшировать локально.
- Аудио по желанию кэшировать после первого прослушивания.
- «Источник правды» — Supabase; кэш только для ускорения и плавной работы.

---

## 5. Storage (Supabase Storage)

- **listening_audio** — файлы аудио по тестам (например `{test_id}/part_1.mp3`).
- **reading_images** — изображения к пассажам (если нужны).
- **speaking_recordings** — опционально, если позже решите хранить записи на сервере.

---

## 6. Итоговая схема «локально vs сервер»

| Категория | Локально (UserData/кэш) | Сервер (Supabase) |
|-----------|--------------------------|-------------------|
| Настройки | Тема, уведомления, предпочтения | — |
| Профиль | — | display_name, avatar, target_band (рекомендуется для мультиустройства) |
| Тесты/вопросы/аудио | Кэш после загрузки | Таблицы + Storage |
| Ответы пользователя | Не храним | Не храним (только в нейросеть) |
| Результаты | — | Баллы по секциям, выводы, все попытки |
| Геймификация | — | Streak, words_learned, current_level |
| Флеш-карточки | — | Слова из ошибок + общая база |
| Ресурсы | — | Метаданные (и при необходимости файлы в Storage) |

Дальше в `docs/supabase_schema.sql` — готовый SQL под создание таблиц, RLS и bucket’ы.
